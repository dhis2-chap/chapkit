<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chap Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      :root {
        font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      body {
        margin: 2rem;
      }
      header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
      }
      #logo {
        max-height: 40px;
        max-width: 120px;
        object-fit: contain;
        display: none; /* hidden until valid URL loads */
      }
      button {
        padding: 0.5rem 0.8rem;
        border-radius: 0.5rem;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      button:disabled {
        opacity: 0.6;
        cursor: progress;
      }
      .status {
        font-size: 0.9rem;
        color: #666;
      }
      pre {
        background: #0b1020;
        color: #d6e7ff;
        padding: 1rem;
        border-radius: 0.75rem;
        overflow: auto;
        max-height: 70vh;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      }
      .error {
        color: #b00020;
      }
    </style>
  </head>
  <body>
    <header>
      <img id="logo" alt="Organization Logo" />
      <h1 style="margin: 0">Chap Service Info</h1>
      <button id="refreshBtn">Refresh</button>
      <span id="status" class="status" aria-live="polite"></span>
    </header>

    <pre id="output" aria-live="polite" aria-busy="true">Loading…</pre>

    <script>
      const output = document.getElementById("output");
      const statusEl = document.getElementById("status");
      const btn = document.getElementById("refreshBtn");
      const logo = document.getElementById("logo");

      async function fetchInfo() {
        btn.disabled = true;
        statusEl.textContent = "Fetching /api/v1/info…";
        output.setAttribute("aria-busy", "true");

        try {
          const res = await fetch("/api/v1/info", {
            headers: { Accept: "application/json" },
            cache: "no-store",
          });

          if (!res.ok) {
            let detail = "";
            try {
              detail = await res.text();
            } catch {}
            throw new Error(
              `HTTP ${res.status} ${res.statusText}${
                detail ? ` — ${detail}` : ""
              }`
            );
          }

          const data = await res.json();
          output.textContent = JSON.stringify(data, null, 2);
          output.classList.remove("error");
          statusEl.textContent = `Updated at ${new Date().toLocaleTimeString()}`;

          // Handle logo
          if (
            data.organization_logo_url &&
            typeof data.organization_logo_url === "string"
          ) {
            logo.src = data.organization_logo_url;
            logo.style.display = "block";
            // Hide logo if loading fails
            logo.onerror = () => {
              logo.style.display = "none";
            };
          } else {
            logo.style.display = "none";
          }
        } catch (err) {
          output.textContent = String(err?.message ?? err);
          output.classList.add("error");
          statusEl.textContent = "Failed to fetch.";
          logo.style.display = "none";
        } finally {
          btn.disabled = false;
          output.setAttribute("aria-busy", "false");
        }
      }

      btn.addEventListener("click", fetchInfo);

      // Initial load
      fetchInfo();
    </script>
  </body>
</html>
